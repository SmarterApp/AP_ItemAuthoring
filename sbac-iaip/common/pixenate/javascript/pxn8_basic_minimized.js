// generated on Thu Nov 30 18:10:36 2006
var PXN8=PXN8 || {};PXN8.root="";PXN8.replaceOnSave=false;PXN8.LANDSCAPE=0;PXN8.PORTRAIT=1;PXN8.ON_ZOOM_CHANGE="ON_ZOOM_CHANGE";PXN8.ON_SELECTION_CHANGE="ON_SELECTION_CHANGE";PXN8.ON_IMAGE_CHANGE="ON_IMAGE_CHANGE";PXN8.ON_IMAGE_ERROR="ON_IMAGE_ERROR";PXN8.ON_IMAGE_LOAD="ON_IMAGE_LOAD";PXN8.history=[];PXN8.responses=[];PXN8.images=[];PXN8.image={ width: 0, height: 0, location: ""
};PXN8.opNumber=0;PXN8.maxOpNumber=0;PXN8.aspectRatio={width:0 , height:0};PXN8.orientation=this.PORTRAIT;PXN8.position={x: "-", y: "-"
};PXN8.response={status: "", image: "", errorCode: 0, errorMessage: "" };PXN8.updating=false;PXN8.resizelimit={ width: 1600,height: 1200
};PXN8.style={notSelected: {opacity: 0.33,color: "black"
},resizeHandles: {color: "white",size: 6,smallsize: 4,oldsize: -1
}};PXN8.imagesBySrc={};PXN8.sx=0;PXN8.sy=0;PXN8.ex=0;PXN8.ey=0;PXN8.initialize=function( param ) {var dom=PXN8.dom;var image_src;if (typeof param=='string'){image_src=param;}else{image_src=param.url;}PXN8.priv.createSelectionRect();var canvas=PXN8.initializeCanvas();var rects=["pxn8_top_rect","pxn8_bottom_rect","pxn8_left_rect","pxn8_right_rect"];for (var i=0;i < rects.length; i++){var rect=dom.id(rects[i]);if (!rect){rect=dom.ac(canvas,dom.ce("div",{id: rects[i]}));}rect.style.fontSize="0px";if (!rect.style.backgroundColor){rect.style.backgroundColor=PXN8.style.notSelected.color;}rect.style.position="absolute";if (!rect.style.opacity){dom.opacity(rect,PXN8.style.notSelected.opacity);}rect.style.top="0px";rect.style.left="0px";rect.style.width="0px";rect.style.height="0px";rect.style.display="none";rect.style.zIndex="1";}PXN8.image.location=image_src;PXN8.opNumber=0;PXN8.maxOpNumber=0;PXN8.history=new Array();var fetchOp={operation: "fetch", image: escape(escape(PXN8.image.location))
};fetchOp.pxn8root=PXN8.root;if (param.filepath){fetchOp.filepath=param.filepath;}PXN8.history.push(fetchOp);if (PXN8.replaceOnSave){fetchOp.random=PXN8.randomHex();}var pxn8image=dom.id("pxn8_image");var onImageLoad=function(pxn8image){PXN8.image.width=pxn8image.width;PXN8.image.height=pxn8image.height;PXN8.priv.addImageToHistory(pxn8image.src);PXN8.show.size();};if (!pxn8image){var imgContainer=dom.id("pxn8_image_container");if (!imgContainer){imgContainer=dom.ac(canvas,dom.ce("div",{id: "pxn8_image_container"}));}pxn8image=dom.ac(imgContainer,dom.ce("img",{id: "pxn8_image", src: PXN8.image.location}));pxn8image.onload=function(){onImageLoad(pxn8image);};}else{var imgContainer=dom.id("pxn8_image_container");dom.cl(imgContainer);pxn8image=dom.ac(imgContainer,dom.ce("img",{id: "pxn8_image", src: PXN8.image.location}));pxn8image.onload=function(){onImageLoad(pxn8image);};}PXN8.event.removeListener(pxn8image,"load",PXN8.imageLoadNotifier);PXN8.event.addListener(pxn8image,"load",PXN8.imageLoadNotifier);onImageLoad(pxn8image);PXN8.show.zoom();};PXN8.imageLoadNotifier=function(){var theImage=PXN8.dom.id("pxn8_image");PXN8.listener.notify(PXN8.ON_IMAGE_LOAD,theImage);};PXN8.initializeCanvas=function(){var dom=PXN8.dom;var canvas=dom.id("pxn8_canvas");canvas.onmousemove=function (event){ if (!event) event=window.event;var cursorPos=PXN8.dom.cursorPos(event);var imagePoint=PXN8.mousePointToElementPoint(cursorPos.x, cursorPos.y);PXN8.position.x=imagePoint.x;PXN8.position.y=imagePoint.y;PXN8.show.position();return true;};canvas.onmouseout=function (event){ if (!event) event=window.event;PXN8.position.x="-";PXN8.position.y="-";PXN8.show.position();};canvas.onmousedown=function (event){if (!event) event=window.event;PXN8.drag.begin(canvas,event,PXN8.drag.moveCanvasHandler,PXN8.drag.upCanvasHandler);};canvas.ondrag=function(){ return false;};var computedCanvasStyle=dom.computedStyle("pxn8_canvas");var canvasPosition=null;if (computedCanvasStyle.getPropertyValue){canvasPosition=computedCanvasStyle.getPropertyValue("position");}else{if (!computedCanvasStyle.position){canvasPosition="static";}else{canvasPosition=computedCanvasStyle.position;}}if (!canvasPosition || canvasPosition=="static"){canvas.style.position="relative";canvas.style.top="0px";canvas.style.left="0px";}var floatProperty="cssFloat";if (document.all){floatProperty="styleFloat";}var floatValue=computedCanvasStyle[floatProperty];if (!floatValue || floatValue=="none"){canvas.style[floatProperty]="left";}return canvas;};PXN8.select=function (startX, startY, width, height){this.sx=startX;this.sy=startY;this.ex=this.sx+width;this.ey=this.sy+height;if (this.sx < 0) this.sx=0;if (this.sy < 0) this.sy=0;if (this.ex > PXN8.image.width) this.ex=PXN8.image.width;if (this.ey > PXN8.image.height) this.ey=PXN8.image.height;this.selectArea();};PXN8.getSelection=function(){var rect={};rect.width=this.ex>this.sx?this.ex-this.sx:this.sx-this.ex;rect.height=this.ey>this.sy?this.ey-this.sy:this.sy-this.ey;rect.left=this.ex>this.sx?this.sx:this.ex;rect.top=this.ey>this.sy?this.sy:this.ey;rect.left=rect.left<0?0:rect.left;rect.top=rect.top<0?0:rect.top; return rect;};PXN8.selectByRatio=function(ratio,override){var dom=PXN8.dom;if (typeof ratio != "string"){alert("Ratio must be expressed as a string e.g. '4x6'");return;}var pair=/^([0-9]+)x([0-9]+)/;var match=ratio.match(pair);if (match != null){var rw=parseInt(match[1]);var rh=parseInt(match[2]);if (override){PXN8.aspectRatio.width=rw;PXN8.aspectRatio.height=rh;}else{if (PXN8.image.width > PXN8.image.height){if (rw > rh){PXN8.aspectRatio.width=rw;PXN8.aspectRatio.height=rh;}else{PXN8.aspectRatio.width=rh;PXN8.aspectRatio.height=rw;}}else{if (rh > rw){PXN8.aspectRatio.width=rh;PXN8.aspectRatio.height=rw;}else{PXN8.aspectRatio.width=rw;PXN8.aspectRatio.height=rh;}}}}else{PXN8.aspectRatio.width=0;PXN8.aspectRatio.height=0;return;}var topRect=dom.id("pxn8_top_rect");topRect.style.borderWidth="1px";var leftRect=dom.id("pxn8_left_rect");leftRect.style.borderWidth="0px";this.sx=0;this.sy=0;var t1=PXN8.image.width / PXN8.aspectRatio.width ;var t2=PXN8.image.height / PXN8.aspectRatio.height ;if (t2 < t1){this.ey=PXN8.image.height;this.ex=Math.round(this.ey / PXN8.aspectRatio.height*PXN8.aspectRatio.width);}else{this.ex=PXN8.image.width;this.ey=Math.round(this.ex / PXN8.aspectRatio.width*PXN8.aspectRatio.height);}this.sx=Math.round((PXN8.image.width-this.ex) / 2);this.sy=Math.round((PXN8.image.height-this.ey) / 2);this.ex += this.sx;this.ey += this.sy;this.selectArea();};PXN8.rotateSelection=function(){var sel=PXN8.getSelection();var cx=sel.left+(sel.width / 2);var cy=sel.top+(sel.height / 2);this.select (cx-sel.height/2, cy-sel.width /2, sel.height, sel.width);};PXN8.selectAll=function() {this.sx=0;this.sy=0;this.ex=PXN8.image.width;this.ey=PXN8.image.height;this.selectArea(); };PXN8.unselect=function () {var dom=PXN8.dom;this.sx=0;this.sy=0;this.ex=0;this.ey=0; var selectionDiv=dom.id("pxn8_select_rect");selectionDiv.style.display="none";var topRect=dom.id("pxn8_top_rect");topRect.style.borderWidth="1px";topRect.style.display="none";var bottomRect=dom.id("pxn8_bottom_rect");bottomRect.style.borderWidth="1px";bottomRect.style.display="none";var leftRect=dom.id("pxn8_left_rect");leftRect.style.display="none";leftRect.style.borderWidth="0px";dom.id("pxn8_right_rect").style.display="none"; PXN8.show.position();PXN8.show.selection();this.listener.notify(PXN8.ON_SELECTION_CHANGE);};PXN8.selectArea=function(){var dom=PXN8.dom;var selectRect=dom.id("pxn8_select_rect");var theImg=dom.id("pxn8_image");var leftRect=dom.id("pxn8_left_rect");var rightRect=dom.id("pxn8_right_rect");var topRect=dom.id("pxn8_top_rect");var bottomRect=dom.id("pxn8_bottom_rect");if (this.sx <=0 && this.sy <= 0 && this.ex <= 0 && this.ey <= 0){selectRect.style.display="none";leftRect.style.display="none";rightRect.style.display="none";topRect.style.display="none";bottomRect.style.display="none";PXN8.listener.notify(PXN8.ON_SELECTION_CHANGE);return;}var t=this.ey > this.sy?this.sy:this.ey;var l=this.ex > this.sx?this.sx:this.ex;var w=this.ex > this.sx?this.ex-this.sx:this.sx-this.ex;var h=this.ey > this.sy?this.ey-this.sy:this.sy-this.ey;if (((this.ex*PXN8.zoom.value()) > theImg.width) ||
((this.ey*PXN8.zoom.value()) > theImg.height)){return;}leftRect.style.display="block";leftRect.style.top="0px";leftRect.style.left="0px";leftRect.style.width=(this.sx*PXN8.zoom.value())+ "px";leftRect.style.height=theImg.height+"px";rightRect.style.display="block";rightRect.style.top="0px";rightRect.style.left=(this.ex*PXN8.zoom.value())+"px";rightRect.style.width=(theImg.width-(this.ex*PXN8.zoom.value()))+"px";rightRect.style.height=theImg.height+"px";topRect.style.display="block";topRect.style.top="0px";topRect.style.left=(l* PXN8.zoom.value())+"px";topRect.style.width=(w* PXN8.zoom.value())+"px";topRect.style.height=(t* PXN8.zoom.value())+"px";bottomRect.style.display="block";bottomRect.style.top=((t+h)* PXN8.zoom.value())+"px";bottomRect.style.left=(l* PXN8.zoom.value())+"px";bottomRect.style.width=(w* PXN8.zoom.value())+"px";bottomRect.style.height=(theImg.height-(this.ey* PXN8.zoom.value()))+"px";selectRect.style.top=(t* PXN8.zoom.value())+"px";selectRect.style.left=(l* PXN8.zoom.value())+"px";selectRect.style.width=(w* PXN8.zoom.value())+"px";selectRect.style.height=(h* PXN8.zoom.value())+"px";selectRect.style.display="block";selectRect.style.zIndex="100"; PXN8.position.x=l;PXN8.position.y=t;PXN8.show.position();PXN8.show.selection();PXN8.listener.notify(PXN8.ON_SELECTION_CHANGE);};PXN8.listener={listenersByType:{}};PXN8.listener.listenersByType[PXN8.ON_ZOOM_CHANGE]=[];PXN8.listener.listenersByType[PXN8.ON_SELECTION_CHANGE]=[];PXN8.listener.listenersByType[PXN8.ON_IMAGE_CHANGE]=[];PXN8.listener.listenersByType[PXN8.ON_IMAGE_ERROR]=[];PXN8.listener.add=function (eventType,callback) {var callbacks=this.listenersByType[eventType];var found=false;if (!callbacks){callbacks=[];this.listenersByType[eventType]=callbacks;}for (var i=0;i < callbacks.length; i++){if (callbacks[i]==callback){found=true;break;}}if (!found){callbacks.push (callback);}};PXN8.listener.remove=function (eventType, callback){var callbacks=this.listenersByType[eventType];if (!callbacks) return;for (var i=0;i < callbacks.length; i++){if (callbacks[i]==callback){callbacks.splice(i,1);}}};PXN8.listener.onceOnly=function (eventType,callback){var wrappedCallback=null;wrappedCallback=function(){callback();PXN8.listener.remove(eventType,wrappedCallback);};this.add(eventType, wrappedCallback);}; PXN8.listener.notify=function(eventType,source){var listeners=this.listenersByType[eventType];if (listeners){for (var i=0; i < listeners.length; i++){var listener=listeners[i];if (listener != null){listener(eventType,source);}}}};PXN8.log={ };PXN8.log.append=function(str){var dom=PXN8.dom;var log=dom.id("pxn8_log");if (log){if (typeof str=="string"){var line=dom.ce("div");dom.ac(line,dom.tx(str));dom.ac(log,line);}else if (typeof str=="object"){var s=PXN8.objectToString(str);var line=dom.ce("div");line.appendChild(dom.tx(s));dom.ac(log,line);}}}; PXN8.zoom={values: [0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 2, 3, 4 ],index: 3,zoomedBy: 1.0,value:function(){return this.zoomedBy;},canZoomIn:function(){return this.zoomedBy < this.values[this.values.length-1];},canZoomOut:function(){return this.zoomedBy > this.values[0];}};PXN8.zoom.zoomIn=function(){if (this.canZoomIn()){for (var i=0; i < this.values.length;i++){if (this.values[i] > this.zoomedBy){this.index=i;this.zoomedBy=this.values[i];break;}}var theImg=document.getElementById("pxn8_image");theImg.width=PXN8.image.width*this.value();theImg.height=PXN8.image.height*this.value();PXN8.selectArea();PXN8.listener.notify(PXN8.ON_ZOOM_CHANGE);}else{PXN8.show.alert(PXN8.strings.NO_MORE_ZOOMIN,500);}return false; };PXN8.zoom.zoomOut=function(){if (this.canZoomOut()){for (var i=this.values.length-1; i >= 0; i--){if (this.values[i] < this.zoomedBy){this.index=i;this.zoomedBy=this.values[i];break;}}var theImg=document.getElementById("pxn8_image");theImg.width=PXN8.image.width*this.value();theImg.height=PXN8.image.height*this.value();PXN8.selectArea();PXN8.listener.notify(PXN8.ON_ZOOM_CHANGE);}else{PXN8.show.alert(PXN8.strings.NO_MORE_ZOOMOUT,500);}return false;}; PXN8.zoom.toSize=function(width, height){var hr=width / PXN8.image.width ;var vr=height / PXN8.image.height ;if (vr < hr){this.zoomedBy=vr;}else{this.zoomedBy=hr;}for (var i=0; i < this.values.length;i++){if (this.values[i] < this.zoomedBy){this.index=i+1;}else{break;}}if (this.index >= this.values.length){this.index=this.values.length -1;}var theImg=document.getElementById("pxn8_image");theImg.width=PXN8.image.width*this.value();theImg.height=PXN8.image.height*this.value();PXN8.selectArea();PXN8.listener.notify(PXN8.ON_ZOOM_CHANGE);return false;};PXN8.zoom.onImageLoad=function(eventType,image){setTimeout(function(){var zoomFactor=PXN8.zoom.value();var ow=image.width;var oh=image.height;var nw=ow*zoomFactor;var nh=oh*zoomFactor;image.width=nw;image.height=nh;PXN8.dom.opacity(image,100);PXN8.selectArea();PXN8.listener.notify(PXN8.ON_ZOOM_CHANGE);},50);};PXN8.listener.add(PXN8.ON_IMAGE_LOAD,PXN8.zoom.onImageLoad);PXN8.getUncompressedImage=function(){if (PXN8.responses[PXN8.opNumber]){return PXN8.responses[PXN8.opNumber].uncompressed;} else {return false;}};PXN8.getScript=function(){var result=new Array();for (var i=0;i <= this.opNumber; i++){var operation={};for (var j in this.history[i]){operation[j]=this.history[i][j];}result.push(operation);}return result;};PXN8.getScriptAsString=function(script){var result="";script=script || PXN8.getScript();for (var i=0;i < script.length; i++){var item=script[i];result=result+item.operation;var props=new Array();for (var property in item){if (property != "operation" && typeof item[property] != "function"){props.push(property);}}props.sort();for (var j=0; j < props.length; j++){result=result+"\t"+props[j]+"="+item[props[j]] ;}result=result+"\n";}return result;};PXN8.curry=function(func,object){return function(){return func(object);};};PXN8.prepareForSubmit=function(msg){var dom=PXN8.dom;if (!msg){msg=PXN8.strings["UPDATING"];} var timer=dom.id("pxn8_timer");if (!timer){timer=dom.ce("div",{id: "pxn8_timer"});dom.ac(timer,dom.tx(msg));var canvas=dom.id("pxn8_canvas");dom.ac(canvas,timer);}if (timer){dom.ac(dom.cl(timer),dom.tx(msg));timer.style.display='block';var theImage=dom.id("pxn8_image");var imagePos=PXN8.dom.ep(theImage);timer.style.width=(theImage.width>200?theImage.width:200)+"px";}PXN8.updating=true;};PXN8.scrolledPoint=function (x,y){var result={"x":x,"y":y};var canvas=document.getElementById("pxn8_canvas");if (canvas.parentNode.id=="pxn8_scroller"){var scroller=document.getElementById("pxn8_scroller");result.x += scroller.scrollLeft;result.y += scroller.scrollTop;}return result;};PXN8.createPin=function (pinId,imgSrc){var pinElement=document.createElement("img");pinElement.id=pinId;pinElement.className="pin";pinElement.src=imgSrc;pinElement.style.position="absolute";pinElement.style.width="24px";pinElement.style.height="24px";return pinElement;};PXN8.mousePointToElementPoint=function(mx,my){var dom=PXN8.dom;var result={};var canvas=dom.id("pxn8_canvas");var imageBounds=dom.eb(canvas);var scrolledPoint=PXN8.scrolledPoint(mx,my);result.x=Math.round((scrolledPoint.x-imageBounds.x)/PXN8.zoom.value());result.y=Math.round((scrolledPoint.y-imageBounds.y)/PXN8.zoom.value());if (canvas.style.borderWidth){var borderWidth=parseInt(canvas.style.borderWidth);result.x -= borderWidth;result.y -= borderWidth;if (result.x < 0){result.x=0;}if (result.y < 0){result.y=0;}}return result;};PXN8.objectToString=function(obj){var s="";var first=true;if (obj.length){s="[";for (var i=0;i < obj.length; i++){if (typeof obj[i]=="string"){s += "\""+obj[i]+"\"";}else if (typeof obj[i]=="object"){s += PXN8.objectToString(obj[i]);}else{s += obj[i];}if (i < obj.length-1){s += ",";}}s += "]";}else{s="{";for (var i in obj){if (first){s += i+":";}else{s += ", "+i+":";}first=false;if (typeof obj[i]=="string"){s += "\""+obj[i]+"\"";}else if (typeof obj[i]=="object"){s += PXN8.objectToString(obj[i]);}else {s += obj[i];}}s += "}";}return s;};PXN8.isArray=function(o){return (o && typeof o=='object') && o.constructor==Array;};PXN8.randomHex=function(){return (Math.round(Math.random()*65535)).toString(16)
};PXN8.replaceImage=function(imageurl){var dom=PXN8.dom;var imageContainer=dom.cl(dom.id("pxn8_image_container"));var theImage=dom.ce("img",{id: "pxn8_image"});dom.ac(imageContainer,theImage);if (PXN8.zoom.value() != 1.0){PXN8.dom.opacity(theImage,1);}PXN8.event.addListener(theImage,"load",PXN8.imageLoadNotifier);theImage.src=imageurl;PXN8.show.size();};PXN8.imageUpdateDone=function (jsonResponse) {var dom=PXN8.dom;var targetDiv=dom.id("pxn8_image_container");PXN8.response=jsonResponse;if (PXN8.response.status=="OK"){var newImageSrc=PXN8.root+"/"+PXN8.response.image;PXN8.responses[PXN8.opNumber]=PXN8.response;if (document.all){newImageSrc += "?rnd="+PXN8.randomHex();}PXN8.replaceImage(newImageSrc);}else{alert("An error occurred while updating the image.\n",PXN8.response.status);PXN8.listener.notify(PXN8.ON_IMAGE_ERROR);}PXN8.log.append(jsonResponse);var timer=dom.id("pxn8_timer");if (timer){timer.style.display="none";}PXN8.updating=false;PXN8.priv.postImageLoad();};PXN8.onEnterKey=function(element,func){element.onkeypress=function(evt){evt=evt || window.event;var charCode=(evt.charCode) ?evt.charCode :((evt.which) ?evt.which :evt.keyCode);if (charCode==13 || charCode==3){if (func){func();return false;}}return true;};};PXN8.loadImage=function( imageLoc ){PXN8.image.location=imageLoc;PXN8.opNumber=0;PXN8.maxOpNumber=0;PXN8.history=new Array();var fetchOp={operation: "fetch",image: escape(escape(PXN8.image.location))};PXN8.history.push(fetchOp);if (PXN8.replaceOnSave){fetchOp.random=PXN8.randomHex();}PXN8.unselect();PXN8.replaceImage(PXN8.image.location);PXN8.priv.postImageLoad();};PXN8.show={};PXN8.show.selection=function(){var dom=PXN8.dom;var selectionField=dom.id("pxn8_selection_size");if (selectionField){var text="N/A";if (PXN8.ex-PXN8.sx > 0){text=(PXN8.ex-PXN8.sx)+","+(PXN8.ey-PXN8.sy);}dom.ac(dom.cl(selectionField),dom.tx(text));}};PXN8.show.position=function(){var dom=PXN8.dom;var posInfo=dom.id("pxn8_mouse_pos");if (posInfo){var text=PXN8.position.x+","+PXN8.position.y;dom.ac(dom.cl(posInfo),dom.tx(text));}};PXN8.show.zoom=function(){var dom=PXN8.dom;var zoomInfo=dom.id("pxn8_zoom");if (zoomInfo){var text=Math.round((PXN8.zoom.value()*100))+"%";dom.ac(dom.cl(zoomInfo),dom.tx(text));}};PXN8.show.size=function (){var dom=PXN8.dom;var sizeInfo=dom.id("pxn8_image_size");if (sizeInfo){var text=PXN8.image.width+"x"+PXN8.image.height;dom.ac(dom.cl(sizeInfo),dom.tx(text));}};PXN8.show.alert=function (message,duration){var dom=PXN8.dom;duration=duration || 1000;var warning=dom.id("pxn8_warning");if (!warning){warning=dom.ce("div",{id: "pxn8_warning",className: "warning"});}warning.style.width=(PXN8.image.width>200?PXN8.image.width:200)+"px";dom.ac(dom.cl(warning),dom.tx(message));dom.ac(dom.id("pxn8_canvas"),warning);setTimeout("PXN8.fade.init();PXN8.fade.fadeout('pxn8_warning',true);",duration);};PXN8.fade={values: [0.99,0.85, 0.70, 0.55, 0.40, 0.25, 0.10, 0],times: [75, 75, 75, 75, 75, 75, 75, 75],i: 0,stopfadeout: false
};PXN8.fade.init=function(){ this.i =0; this.stopfadeout=false;};PXN8.fade.cancel=function(){ this.stopfadeout=true; };PXN8.fade.fadeout=function(eltid,destroyOnFade){var dom=PXN8.dom;if (this.stopfadeout){return;}dom.opacity(dom.id(eltid),this.values[this.i]);if (this.i < this.values.length -1 ){this.i++;setTimeout("PXN8.fade.fadeout('"+eltid+"',"+destroyOnFade+");",this.times[this.i]);}else{if (destroyOnFade){var node=dom.id(eltid);if (!node){return;}else{var parent=node.parentNode;parent.removeChild(node);}}}};PXN8.fade.fadein=function(eltid){var dom=PXN8.dom;try{if (this.i >= this.values.length){this.i=this.values.length-1;}dom.opacity(dom.id(eltid),this.values[this.i]);if (this.i > 0){this.i--;setTimeout("PXN8.fade.fadein('"+eltid+"');",this.times[this.i]);}}catch(e){alert(e);}};PXN8.priv={};PXN8.priv.addImageToHistory=function(imageLocation){PXN8.log.append(" addImageToHistory ("+imageLocation+" "+PXN8.image.width+","+PXN8.image.height+")");var item={"location": imageLocation,"width": PXN8.image.width,"height": PXN8.image.height
};PXN8.images[PXN8.opNumber]=item;for (var i=0; i <= PXN8.maxOpNumber; i++){var item=PXN8.images[i];if (item){PXN8.log.append("-- [" +i+ "] "+item.location+" "+item.width+","+item.height);}}PXN8.log.append("---------");};PXN8.priv.postImageLoad=function(){var dom=PXN8.dom;var theImage=dom.id("pxn8_image");theImage.onerror=function(){alert(PXN8.strings.IMAGE_ON_ERROR1+theImage.src+PXN8.strings.IMAGE_ON_ERROR2);PXN8.listener.notify(PXN8.ON_IMAGE_ERROR);};var onloadFunc=function(){PXN8.log.append("image "+theImage.src+" has loaded");	PXN8.image.width=theImage.width;PXN8.image.height=theImage.height;PXN8.show.size();PXN8.priv.addImageToHistory(theImage.src);if (PXN8.sx > PXN8.image.width || PXN8.ex > PXN8.image.width || PXN8.sy > PXN8.image.height || PXN8.ey > PXN8.image.height){PXN8.unselect();}else{PXN8.selectArea();}PXN8.imagesBySrc[theImage.src]=true;PXN8.listener.notify(PXN8.ON_IMAGE_CHANGE);PXN8.show.zoom(); };if (PXN8.imagesBySrc[theImage.src]){onloadFunc();}else{theImage.onload=onloadFunc;}PXN8.show.zoom();};PXN8.priv.createSelectionRect=function(){var dom=PXN8.dom;var selectRect=dom.id("pxn8_select_rect");if (!selectRect){var canvas=dom.id("pxn8_canvas");selectRect=dom.ac(canvas, dom.ce("div", {id: "pxn8_select_rect"}));selectRect.style.backgroundColor="white";dom.opacity(selectRect,0);selectRect.style.cursor="move";selectRect.style.borderWidth="1px";selectRect.style.borderColor="red";selectRect.style.borderStyle="dotted";selectRect.style.position="absolute";selectRect.style.zIndex=1;selectRect.style.fontSize="0px";selectRect.style.display="block";selectRect.style.width="0px";selectRect.style.height="0px";}selectRect.onmousedown=function(event){ if (!event) event=window.event;PXN8.drag.begin(selectRect,event,PXN8.drag.moveSelectionBoxHandler,PXN8.drag.upSelectionBoxHandler);};return selectRect;};PXN8.listener.add(PXN8.ON_IMAGE_CHANGE, PXN8.show.zoom);PXN8.listener.add(PXN8.ON_ZOOM_CHANGE, PXN8.show.zoom);var PXN8=PXN8 || {};PXN8.ajax={};PXN8.ajax.createRequest=function(){if (typeof XMLHttpRequest != 'undefined') {return new XMLHttpRequest();}	try {return new ActiveXObject("Msxml2.XMLHTTP");} catch (e) {try {return new ActiveXObject("Microsoft.XMLHTTP");} catch (e) { }}return false;};PXN8.ajax.submitScript=function(script, callback){var req=PXN8.ajax.createRequest();PXN8.json.bind(req,callback,function(r){alert(PXN8.strings.WEB_SERVER_ERROR+"\n"+r.statusText+"\n"+r.responseText) ;var timer=document.getElementById("pxn8_timer");if (timer){timer.style.display="none";}PXN8.updating=false;});req.open("POST", PXN8.root+"/pxn8.pl", true);req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');var scriptToText=PXN8.getScriptAsString(script);var submission="script="+scriptToText;req.send(submission);};PXN8.ajax.submitOperation=function(operation, callback){var allops=new Array();for (var i=0;i < PXN8.opNumber; i++){allops.push(PXN8.history[i]);}allops.push(operation);PXN8.prepareForSubmit();PXN8.ajax.submitScript(allops,callback);};PXN8.json={};PXN8.json.bind=function(request,callback,onerror){request.onreadystatechange=function(){if (request.readyState==4) {if (request.status==200) {var json ;try{json=eval('('+ request.responseText+')');}catch (e){alert("An exception occured tring to evaluate server response:\n"+request.responseText);}callback(json);} else {if (onerror){onerror(request);}else{alert(PXN8.strings.WEB_SERVER_ERROR+"\n"+request.statusText+"\n"+request.responseText) ;}}}};};var PXN8=PXN8 || {};PXN8.event={addListener: function(el,eventstr,func){if (el.addEventListener){el.addEventListener(eventstr,func,true);}else if (el.attachEvent){el.attachEvent("on"+eventstr,func);}},removeListener: function(el,eventstr,func){if (el.removeEventListener){el.removeEventListener(eventstr,func,true);}else if (el.detachEvent){el.detachEvent("on"+eventstr,func);}},closure: function(object,func){return function(event){event=event || window.event;var source=(window.event) ? event.srcElement:event.target;func(event,object,source,arguments.callee);};},normalize: function(func){return function(event){event=event || window.event;var source=(window.event) ? event.srcElement:event.target;func(event,source,arguments.callee);};}};PXN8.behaviour={bind: function(className,behaviourObject){var elements=PXN8.dom.clz(className);for (var i=0;i < elements.length; i++){for (var j in behaviourObject){PXN8.event.addListener(elements[i],j,behaviourObject[j]);}}}};var PXN8=PXN8 || {};PXN8.drag={dx: 0,dy: 0,beginDragX: 0,beginDragY: 0,osx: 0,osy: 0,ow: 0,oh: 0
};PXN8.drag.begin=function (elementToDrag, event, moveHandler, upHandler){var dom=PXN8.dom;var elementBounds=dom.eb(elementToDrag);var cursorPos=dom.cursorPos(event);var scrolledPoint=PXN8.scrolledPoint(cursorPos.x,cursorPos.y);PXN8.drag.beginDragX=scrolledPoint.x;PXN8.drag.beginDragY=scrolledPoint.y;PXN8.drag.dx=scrolledPoint.x-elementBounds.x;PXN8.drag.dy=scrolledPoint.y-elementBounds.y;PXN8.drag.osx=PXN8.sx;PXN8.drag.osy=PXN8.sy;PXN8.drag.ow=PXN8.ex-PXN8.sx;PXN8.drag.oh=PXN8.ey-PXN8.sy;if (document.addEventListener){document.addEventListener("mousemove", moveHandler, true);document.addEventListener("mouseup", upHandler, true);}else if (document.attachEvent){document.attachEvent("onmousemove",moveHandler);document.attachEvent("onmouseup",upHandler);}if (event.stopPropogation) event.stopPropogation();else event.cancelBubble=true; 
if (event.preventDefault){event.preventDefault(); 
}else {event.returnValue=false; 
}};PXN8.drag.moveCanvasHandler=function (event){var dom=PXN8.dom;if (!event) event=window.event; 
var canvasBounds=dom.eb(dom.id("pxn8_canvas"));var theImg=dom.id("pxn8_image");var maxX=canvasBounds.x+theImg.width;var maxY=canvasBounds.y+theImg.height;var cursorPos=dom.cursorPos(event);var scrolledPoint=PXN8.scrolledPoint(cursorPos.x, cursorPos.y);var x2=scrolledPoint.x>maxX?maxX:scrolledPoint.x; x2=x2 < canvasBounds.x?canvasBounds.x:x2;var y2=scrolledPoint.y>maxY?maxY:scrolledPoint.y;y2=y2 < canvasBounds.y?canvasBounds.y:y2;var numerical=function(a,b){return a-b;};var xVals=[PXN8.drag.beginDragX-canvasBounds.x,x2-canvasBounds.x].sort(numerical);var yVals=[PXN8.drag.beginDragY-canvasBounds.y,y2-canvasBounds.y].sort(numerical);var pixelWidth=xVals[1]-xVals[0];var pixelHeight=yVals[1]-yVals[0];var width=Math.round(pixelWidth / PXN8.zoom.value());var height=Math.round(pixelHeight / PXN8.zoom.value());height=height > PXN8.image.height?PXN8.image.height:height;width=width > PXN8.image.width?PXN8.image.width:width;if (width > PXN8.aspectRatio.width &&
height > PXN8.aspectRatio.height &&
PXN8.aspectRatio.width > 0){if (PXN8.aspectRatio.width > PXN8.aspectRatio.height){height=Math.round(width/PXN8.aspectRatio.width *PXN8.aspectRatio.height);}else{width=Math.round(height/PXN8.aspectRatio.height *PXN8.aspectRatio.width);}}PXN8.sx=Math.round(xVals[0]/PXN8.zoom.value());PXN8.ex=PXN8.sx+width;PXN8.sy=Math.round(yVals[0]/PXN8.zoom.value());PXN8.ey=PXN8.sy+height;PXN8.selectArea();if (event.stopPropogation) event.stopPropogation(); 
else event.cancelBubble=true; 
};PXN8.drag.upCanvasHandler=function (event){PXN8.log.append("aspect_ratio: width="+PXN8.aspectRatio.width+", height="+PXN8.aspectRatio.height);if (!event) event=window.event ; 
if (document.removeEventListener){document.removeEventListener("mouseup",PXN8.drag.upCanvasHandler,true);document.removeEventListener("mousemove",PXN8.drag.moveCanvasHandler, true);}else if (document.detachEvent){document.detachEvent("onmouseup",PXN8.drag.upCanvasHandler);document.detachEvent("onmousemove",PXN8.drag.moveCanvasHandler);}if (event.stopPropogation) event.stopPropogation(); 
else event.cancelBubble=true; 
};PXN8.drag.moveSelectionBoxHandler=function (event){var dom=PXN8.dom;if (!event) event=window.event; 
var canvasBounds=dom.eb(dom.id("pxn8_canvas"));var theImg=dom.id("pxn8_image");var mx=canvasBounds.x+theImg.width;var my=canvasBounds.y+theImg.height;var cursorPos=dom.cursorPos(event);var scrolledPoint=PXN8.scrolledPoint(cursorPos.x, cursorPos.y);var rx=scrolledPoint.x-PXN8.drag.beginDragX;var ry=scrolledPoint.y-PXN8.drag.beginDragY;PXN8.sx=Math.round((PXN8.drag.osx+(rx/PXN8.zoom.value()))>0?(PXN8.drag.osx+(rx/PXN8.zoom.value())):0);PXN8.sx=Math.round((PXN8.sx+PXN8.drag.ow)>PXN8.image.width?(PXN8.image.width-PXN8.drag.ow):PXN8.sx);PXN8.sy=Math.round((PXN8.drag.osy+(ry/PXN8.zoom.value()))>0?(PXN8.drag.osy+(ry/PXN8.zoom.value())):0);PXN8.sy=Math.round((PXN8.sy+PXN8.drag.oh)>PXN8.image.height?(PXN8.image.height-PXN8.drag.oh):PXN8.sy);PXN8.ex=(PXN8.sx+PXN8.drag.ow)>0?(PXN8.sx+PXN8.drag.ow):0;PXN8.ey=(PXN8.sy+PXN8.drag.oh)>0?(PXN8.sy+PXN8.drag.oh):0;if (event.stopPropogation) event.stopPropogation(); 
else event.cancelBubble=true; 
PXN8.selectArea();};PXN8.drag.upSelectionBoxHandler=function (event){if (!event) event=window.event ; 
if (document.removeEventListener){document.removeEventListener("mouseup",PXN8.drag.upSelectionBoxHandler,true);document.removeEventListener("mousemove",PXN8.drag.moveSelectionBoxHandler, true);}else if (document.detachEvent){document.detachEvent("onmouseup",PXN8.drag.upSelectionBoxHandler);document.detachEvent("onmousemove",PXN8.drag.moveSelectionBoxHandler);}if (event.stopPropogation) event.stopPropogation(); 
else event.cancelBubble=true; 
};var PXN8=PXN8 || {};PXN8.resize={dx: 0,dy: 0,start_width: 0,start_height: 0,canResizeNorth: function(yOffset){return (PXN8.sy+yOffset < (PXN8.ey-PXN8.style.resizeHandles.size)) && (PXN8.sy+yOffset > 0);},canResizeWest: function(xOffset){return (PXN8.sx+xOffset < (PXN8.ex-PXN8.style.resizeHandles.size)) && (PXN8.sx+xOffset > 0);},canResizeSouth: function(yOffset){return (PXN8.ey+yOffset > (PXN8.sy+PXN8.style.resizeHandles.size)) && (PXN8.ey+yOffset < PXN8.image.height);},canResizeEast: function(xOffset){return (PXN8.ex+xOffset > (PXN8.sx+PXN8.style.resizeHandles.size)) && (PXN8.ex+xOffset < PXN8.image.width);},nTest: function(xOffset,yOffset,event){if (PXN8.resize.canResizeNorth(yOffset) && PXN8.aspectRatio.width==0) {PXN8.resize.dy=event.clientY;PXN8.sy=Math.round(PXN8.sy+yOffset);return true;}return false;},sTest: function(xOffset,yOffset,event){if (PXN8.resize.canResizeSouth(yOffset) && PXN8.aspectRatio.width==0){PXN8.resize.dy=event.clientY;PXN8.ey=Math.round(PXN8.ey+yOffset);return true;}return false;},wTest: function(xOffset,yOffset,event){if (PXN8.resize.canResizeWest(xOffset) && PXN8.aspectRatio.width==0) {PXN8.resize.dx=event.clientX;PXN8.sx=Math.round(PXN8.sx+xOffset);return true;}return false;},eTest: function(xOffset,yOffset,event){if (PXN8.resize.canResizeEast(xOffset) && PXN8.aspectRatio.width==0){PXN8.resize.dx=event.clientX;PXN8.ex=Math.round(PXN8.ex+xOffset);return true;}return false;},nwTest: function(xOffset,yOffset,event){if (xOffset==0 || yOffset==0){return false;}var hr=PXN8.resize.start_height/PXN8.resize.start_width;var wr=1 / hr;if (wr > hr){xOffset=yOffset*wr;}else if (wr < hr){yOffset=xOffset*hr;}else{yOffset=xOffset;}if (xOffset > 0){yOffset=Math.abs(yOffset);}else{yOffset=0-Math.abs(yOffset);}if (PXN8.resize.canResizeWest(xOffset) && PXN8.resize.canResizeNorth(yOffset)){PXN8.resize.dx=event.clientX;PXN8.resize.dy=event.clientY;PXN8.sx=Math.round(PXN8.sx+xOffset);PXN8.sy=Math.round(PXN8.sy+yOffset);return true;}return false;},swTest: function(xOffset,yOffset,event) {if (xOffset==0 || yOffset==0){return false;}var hr=PXN8.resize.start_height/PXN8.resize.start_width;var wr=1 / hr;if (wr > hr){yOffset=xOffset*wr;}else{yOffset=xOffset;}if (xOffset > 0){yOffset=0-Math.abs(yOffset);}else{yOffset=Math.abs(yOffset);}if (PXN8.resize.canResizeWest(xOffset) && PXN8.resize.canResizeSouth(yOffset)){PXN8.resize.dx=event.clientX;PXN8.resize.dy=event.clientY;PXN8.sx=Math.round(PXN8.sx+xOffset);PXN8.ey=Math.round(PXN8.ey+yOffset);return true;}return false;},neTest: function(xOffset,yOffset,event) {if (xOffset==0 || yOffset==0){return false;}var hr=PXN8.resize.start_height/PXN8.resize.start_width;var wr=1 / hr;if (wr > hr){xOffset=yOffset*wr;}else{xOffset=yOffset;}if (yOffset > 0){xOffset=0-Math.abs(xOffset);}else{xOffset=Math.abs(xOffset);}if (PXN8.resize.canResizeEast(xOffset) && PXN8.resize.canResizeNorth(yOffset)){ PXN8.resize.dx=event.clientX;PXN8.resize.dy=event.clientY;PXN8.ex=Math.round(PXN8.ex+xOffset);PXN8.sy=Math.round(PXN8.sy+yOffset);return true;}return false;},seTest: function(xOffset,yOffset,event) {if (xOffset==0 || yOffset==0){return false;}var hr=PXN8.resize.start_height/PXN8.resize.start_width;var wr=1 / hr;if (wr > hr){xOffset=yOffset*wr;}else{yOffset=xOffset;}if (xOffset > 0){yOffset=Math.abs(yOffset);}else{yOffset=0-Math.abs(yOffset);}if (PXN8.resize.canResizeEast(xOffset) && PXN8.resize.canResizeSouth(yOffset)){PXN8.resize.dx=event.clientX;PXN8.resize.dy=event.clientY;PXN8.ex=Math.round(PXN8.ex+xOffset);PXN8.ey=Math.round(PXN8.ey+yOffset);return true;}return false;},stopResizing: function(event){if (!event) event=window.event ; 
if (document.removeEventListener){document.removeEventListener("mouseup",PXN8.resize.stopResizing,true);for (var i in PXN8.resize.handles){document.removeEventListener("mousemove",PXN8.resize.handles[i].moveHandler, true);}}else if (document.detachEvent){document.detachEvent("onmouseup",PXN8.resize.stopResizing);for (var i in PXN8.resize.handles){document.detachEvent("onmousemove",PXN8.resize.handles[i].moveHandler);}}if (event.stopPropogation) event.stopPropogation(); 
else event.cancelBubble=true; 
},startResizing: function(hdlr){var result=function(event){if (!event) event=window.event;PXN8.resize.dx=event.clientX;PXN8.resize.dy=event.clientY;var sel=PXN8.getSelection();PXN8.resize.start_height=sel.height;PXN8.resize.start_width=sel.width;if (document.addEventListener){document.addEventListener("mousemove", hdlr, true);document.addEventListener("mouseup", PXN8.resize.stopResizing, true);}else if (document.attachEvent){document.attachEvent("onmousemove",hdlr);document.attachEvent("onmouseup",PXN8.resize.stopResizing);}if (event.stopPropogation) event.stopPropogation();else event.cancelBubble=true; 
if (event.preventDefault) event.preventDefault(); 
else event.returnValue=false; 
};return result;},createResizeHandle: function(direction,size,color) {var result=document.createElement("div");result.id=direction+"_handle";result.style.backgroundColor=color;result.style.position="absolute";result.style.width=size+"px";result.style.height=size+"px";result.style.overflow="hidden"; result.style.zIndex=999;result.style.cursor=direction+"-resize";result.onmousedown=PXN8.resize.startResizing(PXN8.resize.handles[direction].moveHandler);result.ondrag=function(){return false;};return result;},positionResizeHandles: function() {var dom=PXN8.dom;var sel=PXN8.getSelection();if (sel.width==0){PXN8.resize.hideResizeHandles();return;}var zoom=PXN8.zoom.value();var rhsz=PXN8.style.resizeHandles.size;var rhsm=PXN8.style.resizeHandles.smallsize;if (((sel.width*zoom <= (rhsz*3)) && rhsz != rhsm) ||
((sel.height*zoom <= (rhsz*3)) && rhsz != rhsm)){}else{}var canvas=dom.id("pxn8_canvas");for (var i in PXN8.resize.handles){var handle=dom.id( i+"_handle");if (!handle){handle=PXN8.resize.createResizeHandle(i, rhsz,PXN8.style.resizeHandles.color);dom.ac(canvas,handle);}else{}if (handle.style.display=="none"){handle.style.display="block";}PXN8.resize.handles[i].position(handle,sel);}},hideResizeHandles: function(hdls) {var dom=PXN8.dom;if (hdls){for (var i =0; i < hdls.length;i++){var handle=dom.id( i+"_handle");if (handle){handle.style.display="none";}}}else{for (var i in PXN8.resize.handles){var handle=dom.id( i+"_handle");if (handle){handle.style.display="none";}}}}};PXN8.resize.resizer=function( testFunc ) {var result=function(event){if (!event) event=window.event;var rdy=event.clientY-PXN8.resize.dy;var rdx=event.clientX-PXN8.resize.dx;var prdy=Math.round(rdy / PXN8.zoom.value());var prdx=Math.round(rdx / PXN8.zoom.value());if (prdx==0 && prdy==0){}else{if (testFunc(prdx,prdy,event)==true){PXN8.selectArea();}}if (event.stopPropogation) event.stopPropogation(); 
else event.cancelBubble=true; 
};return result;};PXN8.resize.handles={"n": { moveHandler: PXN8.resize.resizer(PXN8.resize.nTest),position: function(handle,sel){var sel_rect=PXN8.dom.eb(PXN8.dom.id("pxn8_select_rect"));handle.style.left=sel_rect.x+Math.ceil(sel_rect.width/2)-(PXN8.style.resizeHandles.size/2)+"px";handle.style.top=sel_rect.y+"px";}},"s": { moveHandler: PXN8.resize.resizer(PXN8.resize.sTest),position: function(handle,sel){var sel_rect=PXN8.dom.eb(PXN8.dom.id("pxn8_select_rect"));handle.style.left=sel_rect.x+Math.ceil(sel_rect.width/2)-(PXN8.style.resizeHandles.size/2)+"px";handle.style.top=Math.round(((sel.top+sel.height)*PXN8.zoom.value())-PXN8.style.resizeHandles.size)+"px";}},"e": { moveHandler: PXN8.resize.resizer(PXN8.resize.eTest),position: function(handle,sel){var sel_rect=PXN8.dom.eb(PXN8.dom.id("pxn8_select_rect"));handle.style.left=Math.round(((sel.left+sel.width)*PXN8.zoom.value())-PXN8.style.resizeHandles.size)+"px";handle.style.top=sel_rect.y+Math.ceil(sel_rect.height / 2)-(PXN8.style.resizeHandles.size / 2)+"px";}},"w": { moveHandler: PXN8.resize.resizer(PXN8.resize.wTest),position: function(handle,sel){var sel_rect=PXN8.dom.eb(PXN8.dom.id("pxn8_select_rect"));handle.style.top=sel_rect.y+Math.ceil(sel_rect.height / 2)-(PXN8.style.resizeHandles.size / 2)+"px";handle.style.left=sel_rect.x+"px";}},"nw": { moveHandler: PXN8.resize.resizer(PXN8.resize.nwTest),position: function(handle,sel){handle.style.left=Math.round(sel.left*PXN8.zoom.value())+"px";handle.style.top=Math.round((sel.top*PXN8.zoom.value()))+"px";}},"sw": { moveHandler: PXN8.resize.resizer(PXN8.resize.swTest),position: function(handle,sel){handle.style.left=Math.round(sel.left*PXN8.zoom.value())+"px";handle.style.top=Math.round(((sel.top+sel.height)*PXN8.zoom.value())-PXN8.style.resizeHandles.size)+"px";}},"ne": { moveHandler: PXN8.resize.resizer(PXN8.resize.neTest),position: function(handle,sel){var sel_rect=PXN8.dom.eb(PXN8.dom.id("pxn8_select_rect"));handle.style.left=Math.round(((sel.left+sel.width)*PXN8.zoom.value())-PXN8.style.resizeHandles.size)+"px";handle.style.top=sel_rect.y+"px";}},"se": { moveHandler: PXN8.resize.resizer(PXN8.resize.seTest),position: function(handle,sel){handle.style.left=Math.round(((sel.left+sel.width)*PXN8.zoom.value())-PXN8.style.resizeHandles.size)+"px";handle.style.top=Math.round(((sel.top+sel.height)*PXN8.zoom.value())-PXN8.style.resizeHandles.size)+"px";}}};PXN8.listener.add(PXN8.ON_SELECTION_CHANGE, PXN8.resize.positionResizeHandles);var PXN8=PXN8 || {};PXN8.dom={cachedComputedStyles: {}};PXN8.dom.cl=function(elt){if (!elt) return false;while (elt.firstChild){ elt.removeChild(elt.firstChild);}return elt;};PXN8.dom.tx=function(str){ return document.createTextNode(str);};PXN8.dom.id=function(str){ return document.getElementById(str);};PXN8.dom.ce=function(nodeType,attrs){var el=document.createElement(nodeType);for (var i in attrs){ el[i]=attrs[i];}return el;};PXN8.dom.ac=function(parent,child){ parent.appendChild(child);return child;};PXN8.dom.eb=function(elt){var x=null;var y=null;if(elt.style.position=="absolute") {x=parseInt(elt.style.left);y=parseInt(elt.style.top);} else {var pos=this.ep(elt); x=pos.x;y=pos.y;} return {x: x, y: y, width: elt.offsetWidth, height: elt.offsetHeight};};PXN8.dom.ep=function (elt){var tmpElt=elt;var posX=parseInt(tmpElt["offsetLeft"]);var posY=parseInt(tmpElt["offsetTop"]);while(tmpElt.tagName.toUpperCase() != "BODY") {tmpElt=tmpElt.offsetParent;posX += parseInt(tmpElt["offsetLeft"]);posY += parseInt(tmpElt["offsetTop"]);} return {x: posX, y:posY};};PXN8.dom.windowSize=function() {if (document.all){return {width: document.body.clientWidth, height: document.body.clientHeight};}else{return {width: window.outerWidth,height: window.outerHeight};} };PXN8.dom.opacity=function(element, value){if (!element){return;}if (document.all){element.style.filter="alpha(opacity:"+(value*100)+")";}else{element.style.opacity=value;element.style._moz_opacity=value;}};PXN8.dom.clz=function(className){var links=document.getElementsByTagName("*");var result=new Array();for (var i=0;i < links.length; i++){if (links[i].className.match(className)){result.push(links[i]);}}return result;};PXN8.dom.computedStyle=function(elementId){var result=null;if (this.cachedComputedStyles[elementId]){result=this.cachedComputedStyles[elementId];}else{var element=this.id(elementId);if (document.all){result=element.currentStyle;}else{if (window.getComputedStyle){result=window.getComputedStyle(element,null); }else{result=element.style;}}this.cachedComputedStyles[elementId]=result;}return result;};PXN8.dom.cursorPos=function (e) {e=e || window.event;var cursor={x:0, y:0};if (e.pageX || e.pageY) {cursor.x=e.pageX;cursor.y=e.pageY;}else {cursor.x=e.clientX+(document.documentElement.scrollLeft ||
document.body.scrollLeft)-document.documentElement.clientLeft;cursor.y=e.clientY+(document.documentElement.scrollTop ||
document.body.scrollTop)-document.documentElement.clientTop;}return cursor;};PXN8.dom.addLoadEvent=function(func){var oldonload=window.onload;if (typeof window.onload != 'function'){window.onload=func;} else {window.onload=function(){if (oldonload){oldonload();}func();};}};PXN8.dom.addClickEvent=function(elt,func){var oldonclick=elt.onclick;if (typeof oldonclick != 'function'){elt.onclick=func;} else {elt.onclick=function(){if (oldonclick){oldonclick(elt);}func(elt);};}};PXN8.dom.onceOnlyClickEvent=function(elt,func){var oldonclick=elt.onclick;PXN8.dom.addClickEvent(elt,function(){func();elt.onclick=oldonclick;});};PXN8.dom.table=function(rows, attributes){var dom=PXN8.dom;var result=dom.ce("table",attributes);var tbody=dom.ce("tbody");result.appendChild(tbody);var mostCells=0;for (var i=0; i < rows.length; i++){var row=rows[i];if (row.length > mostCells){mostCells=row.length;}}for (var i=0; i < rows.length; i++){var tr=dom.ce("tr");tbody.appendChild(tr);var rowData=rows[i];var cellsInRow=rowData.length;for (var j=0; j < rows[i].length; j++){var cellData=rows[i][j];var td=dom.ce("td");tr.appendChild(td);if (j==rows[i].length -1 && cellsInRow < mostCells){td.colSpan=(mostCells-cellsInRow)+1;}if (typeof cellData=="string"){td.appendChild(dom.tx(cellData));}else if (PXN8.isArray(cellData)){for (var k=0; k < cellData.length; k++){if (typeof cellData[k]=="string"){td.appendChild(dom.tx(cellData[k]));}else{td.appendChild(cellData[k]);}}}else{td.appendChild(cellData);}}}	return result;};var PXN8=PXN8 || {};PXN8.save={};PXN8.save.toDisk=function(){var uncompressedImage=PXN8.getUncompressedImage();if (uncompressedImage){var newURL=PXN8.root+"/save.pl?";if (typeof pxn8_original_filename=="string"){newURL += "originalFilename="+pxn8_original_filename+"&";}newURL += "image="+uncompressedImage;document.location=newURL;}else{document.location="#";PXN8.show.alert("You have not changed the image !");}};PXN8.save.toFlickr=function(form){if (typeof form=='undefined'){alert("Incorrect use of PXN8.save.toFlickr-this should be called via a form's onsubmit attribute");return false;}if (PXN8.opNumber==0){PXN8.show.alert("You have not changed the image !");return false;}var input=document.createElement("input");input.type="hidden";input.name="img";input.value=PXN8.getUncompressedImage();form.appendChild(input);return true;};PXN8.save.allyoucanupload=function(){var dom=PXN8.dom;PXN8.prepareForSubmit('Saving image. Please wait...');var req=PXN8.ajax.createRequest();req.open("GET", PXN8.root+"/allyoucanupload.pl?image="+PXN8.getUncompressedImage(),true);PXN8.json.bind(req, function(response){var timer=document.getElementById("pxn8_timer");if (timer){timer.style.display="none";}PXN8.updating=false;prompt("Here is the permanent URL for your image.\n"+"Copy and paste this URL into your blog, myspace or bebo page.",response.original_image);});req.send(null);};PXN8.save.toServer=function(){var relativeFilePathToUncompressedImage=PXN8.getUncompressedImage();if (!relativeFilePathToUncompressedImage){alert("The image has not been modified.");return false;}if (typeof pxn8_save_image=='function'){return pxn8_save_image(relativeFilePathToUncompressedImage);} else {alert("This feature is not available by default.\n"+"To enable this feature you must create a PHP,ASP or JSP page to save the image to your own server.\n"+"You must also create a javascript function called 'pxn8_save_image()'-it's first parameter is the URL of the changed image.\n"+"The path to the changed image (relative to the directory where PXN8 is installed) is "+PXN8.getUncompressedImage());return false;}};var PXN8=PXN8 || {};PXN8.tools={};PXN8.tools.history=function (offset){if (offset==0){return;}if (PXN8.updating){alert (PXN8.strings.IMAGE_UPDATING);return;}if (!offset) offset=-1;if (PXN8.opNumber==0 && offset < 0){PXN8.show.alert(PXN8.strings.NO_MORE_UNDO);return;}if (PXN8.opNumber==PXN8.maxOpNumber && offset > 0){PXN8.show.alert(PXN8.strings.NO_MORE_REDO);return;}	if (offset < 0){PXN8.show.alert("- "+PXN8.history[PXN8.opNumber].operation, 500);}else{PXN8.log.append("redo: "+PXN8.opNumber);for (var i=0;i < PXN8.history.length; i++){PXN8.log.append("redo: "+PXN8.history[i].operation);}PXN8.show.alert("+ "+PXN8.history[PXN8.opNumber+1].operation,500);}PXN8.opNumber=PXN8.opNumber+offset;var currentImageData=PXN8.images[PXN8.opNumber];if (!currentImageData){alert("Error! PXN8.images["+PXN8.opNumber+"] is undefined");return false;}PXN8.image.location=currentImageData.location;PXN8.image.width=currentImageData.width;PXN8.image.height=currentImageData.height;PXN8.replaceImage(PXN8.image.location);PXN8.listener.notify(PXN8.ON_IMAGE_CHANGE); PXN8.unselect();return false;};PXN8.tools.undo=function(){PXN8.tools.history(-1);return false;};PXN8.tools.redo=function(){PXN8.tools.history(+1);return false;};PXN8.tools.undoall=function(){PXN8.tools.history(0-PXN8.opNumber);return false;};PXN8.tools.redoall=function(){PXN8.tools.history(PXN8.maxOpNumber-PXN8.opNumber);return false;};PXN8.tools.updateImage=function(op){var executed=true;if (PXN8.maxOpNumber > PXN8.opNumber){var lastUndoneOp=PXN8.history[PXN8.opNumber+1];for (var i in op){if (lastUndoneOp[i]==op[i]){}else{executed=false;break;}}}else{executed=false;}if (!executed){if (PXN8.updating){alert (PXN8.strings.IMAGE_UPDATING);return;}PXN8.history[++PXN8.opNumber]=op;PXN8.maxOpNumber=PXN8.opNumber;PXN8.ajax.submitOperation(op ,PXN8.imageUpdateDone);}else{PXN8.tools.redo();}};PXN8.tools.enhance=function(){PXN8.tools.updateImage({operation: "enhance"});};PXN8.tools.instantFix=function(){PXN8.tools.updateImage({operation: "instant_fix"});};PXN8.tools.normalize=function(){PXN8.tools.updateImage({operation: "normalize"});};PXN8.tools.spiritlevel=function(x1,y1,x2,y2){PXN8.tools.updateImage({operation: "spiritlevel", 'x1': x1, 'x2': x2, 'y1': y1, 'y2':y2});};PXN8.tools.rotate=function(params){if (!params.angle){ params.angle=0;}if (params.fliphz==null){params.fliphz=false;}if (params.flipvt==null){params.flipvt=false;}params.operation="rotate";if (params.angle > 0 || params.flipvt || params.fliphz){PXN8.tools.updateImage(params);}};PXN8.tools.blur=function (params){params.operation="blur";PXN8.tools.updateImage(params);};PXN8.tools.colors=function(param){if (!param.saturation) param.saturation=100;if (!param.brightness) param.brightness=100;if (!param.hue) param.hue=100;if (!param.contrast) param.contrast=0;param.operation="bsh";PXN8.tools.updateImage(param);};PXN8.tools.crop=function (params) {params.operation="crop";PXN8.tools.updateImage(params);};PXN8.tools.filter=function (params){params.operation="filter";PXN8.tools.updateImage(params);};PXN8.tools.interlace=function(params){params.operation="interlace";PXN8.tools.updateImage(params);};PXN8.tools.lomo=function(params){params.operation="lomo";PXN8.tools.updateImage(params);};PXN8.tools.fill_flash=function(brightness, threshold){PXN8.tools.updateImage({operation: "fill_flash"});};PXN8.tools.snow=function (){PXN8.tools.updateImage({operation: "snow"});};PXN8.tools.add_text=function(params){params.operation="add_text";PXN8.tools.updateImage(params);}PXN8.tools.whiten=function (params){params.operation="whiten";PXN8.tools.updateImage(params);};PXN8.tools.fixredeye=function(params){params.operation="redeye";PXN8.tools.updateImage(params);};PXN8.tools.resize=function(width, height){PXN8.tools.updateImage({"operation": "resize", "width": width, "height": height});};PXN8.tools.roundedcorners=function(color, radius){PXN8.tools.updateImage({"operation":"roundcorners","color":color, "radius":radius});};PXN8.tools.sepia=function(color){PXN8.tools.updateImage({"operation":"sepia","color":color});};PXN8.tools.grayscale=function(){PXN8.tools.updateImage({"operation":"grayscale"});};PXN8.tools.charcoal=function(radius){PXN8.tools.updateImage({"operation":"charcoal", "radius":radius});}PXN8.tools.oilpaint=function(radius){PXN8.tools.updateImage({"operation":"oilpaint", "radius":radius});}var PXN8=PXN8 || {};PXN8.ON_HIRES_COMPLETE="ON_HIRES_COMPLETE";PXN8.ON_HIRES_BEGIN="ON_HIRES_BEGIN";PXN8.hires={originalURL: "",responses:[],jsonCallback:function(jsonResponse){PXN8.listener.notify(PXN8.ON_HIRES_COMPLETE,jsonResponse);}};PXN8.hires.scaleScript=function(script,ratio){var paramsToScale=["left","width","top","height","radius"];for (var i=0;i < script.length; i++){var op=script[i];for (var j=0; j < paramsToScale.length; j++){var attr=paramsToScale[j];if (op[attr]){op[attr]=op[attr]*ratio;}}}};PXN8.hires.doImageChange=function(eventType){var loRes=PXN8.images[0];var ratio=PXN8.hires.responses[0].height / loRes.height;var script=PXN8.getScript();script[0].image=PXN8.hires.originalURL;PXN8.hires.scaleScript(script,ratio);PXN8.log.append("about to submit: "+ PXN8.objectToString(script));PXN8.listener.notify(PXN8.ON_HIRES_BEGIN);PXN8.ajax.submitScript(script,PXN8.hires.jsonCallback);};PXN8.hires.init=function(imageUrl){PXN8.listener.add(PXN8.ON_HIRES_COMPLETE,function(eventType,jsonResponse){PXN8.hires.responses[jsonResponse.opNumber-1]=jsonResponse;PXN8.log.append("hires: "+ PXN8.objectToString(jsonResponse));});PXN8.hires.originalURL=imageUrl;var fetch={operation: "fetch",image: imageUrl,pxn8root: PXN8.root,random: Math.random()
};PXN8.listener.notify(PXN8.ON_HIRES_BEGIN);PXN8.ajax.submitScript([fetch],PXN8.hires.jsonCallback);PXN8.listener.add(PXN8.ON_IMAGE_CHANGE,PXN8.hires.doImageChange);PXN8.getUncompressedImage=PXN8.hires.getUncompressedImage;};PXN8.hires.getUncompressedImage=function(){var result=false;if (PXN8.hires.responses[PXN8.opNumber]){result=PXN8.hires.responses[PXN8.opNumber].uncompressed;}return result;};